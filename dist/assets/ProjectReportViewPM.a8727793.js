import{C as g}from"./index.3bbb47f2.js";import{B as T}from"./BreadCrumb.9367f10a.js";import{D as B}from"./validator.a755279e.js";import{a as I,b as V,c as q,d as N}from"./form.181df029.js";import{D as U}from"./select-box.029c2d7e.js";import{_ as L}from"./date-box.adbab50c.js";import{R as h}from"./RepositoryFactory.1ead146f.js";import{_ as A}from"./number-box.9a45bbe3.js";import{_ as z}from"./button.996b9c36.js";import{g as J,D as H,a as W,v as K,u as Y,c as Q,d as X,l as Z,e as $,i as ee,b as te,h as ae,k as oe}from"./data-grid.24b081de.js";import{c as re}from"./CellLinkTemplate.75b044c2.js";import{_ as se,a as ie}from"./index.7b655b97.js";import{c as i,r as n,o as ne,a as ce,f as r,w as d}from"./vendor.7710df40.js";const f="https://kameyo-api.azurewebsites.net",le=h.get("subsidiaries"),_=h.get("employees"),de=h.get("projects"),he=h.get("authenticate"),y=`${f}/api/employee`,b=`${f}/api/projectTasks`,x=`${f}/api/ProjectReport`,ue=h.get("projectReport");function pe(a){return a!=null&&a!==""}const me={name:"ActivitiesView",components:{BreadCrumb:T,DxForm:I,DxSimpleItem:V,DxGroupItem:q,DxLabel:N,DxNumberBox:A,DxRequiredRule:B,DxPopup:J,DxSelectBox:U,DxDateBox:L,DxButton:z,DxDataGrid:H,DxColumn:W,DxGrouping:K,DxGroupPanel:Y,DxPager:Q,DxPaging:X,DxSearchPanel:Z,DxEditing:$,DxFilterRow:ee,DxScrolling:te,DxLookup:ae,DxHeaderFilter:oe,cellLink:re},data(){return{idSubsidiary:0,idprojectManager:0,idProject:0,idTask:0,months:[],years:[],year:0,month:0,hasPM:!0,periodo:"",dataSource:{},subsidiary:[],projectManager:[],project:[],task:[],searchModeOption:"contains",searchExprOption:"name",searchTimeoutOption:200,minSearchLengthOption:0,showDataBeforeSearchOption:!1,employee:new g({key:"id",load:()=>this.sendRequest(`${y}/paginated`,"GET",{}).then(a=>{let e=a.map(o=>({id:o.id,name:`${o.lastName} ${o.names}`}));return console.log("carga",e),e}),byKey:a=>this.sendRequest(`${y}`,"GET",{Field:"ID",Value:a}).then(e=>e.map(s=>({id:s.id,name:`${s.lastName} ${s.names}`})))}),projects:new g({key:"id",load:()=>this.sendRequest(`${b}/paginated`,"GET",{}).then(a=>a),byKey:a=>this.sendRequest(`${b}`,"GET",{Field:"ID",Value:a}).then(e=>e)})}},methods:{subsidiaryChange:async function(a){this.projectManager=null,this.project=[],this.task=[];let e=[];e.skip=0,e.take=0,e.requireTotalCount=!0,e.filter='["subsidiaryId","=","'+a.value+'"]';const{data:o}=await _.GetWithFilter(e);this.projectManager=o.data},projectManagerChange:async function(a){this.project=[],this.task=[],this.dataSource={};let e=[];e.skip=0,e.take=0,e.requireTotalCount=!0,e.filter='["projectManagerId","=","'+a.value+'"]';const{data:o}=await de.GetWithFilter(e);this.project=o.data,this.idProject=0,this.idTask=0},getSubsidiaries:async function(){const{data:a}=await le.GetWithPagination({});this.subsidiary=a.data},getEmployees:async function(){const{data:a}=await _.GetWithPagination({});console.log(a),this.projectManager=a.data},validateUser:async function(){const a=ie();if(a.isAuthenticated){const e=a.getAuthenticatedUser;this.userName=e.userName;let o="";he.ValidateUser(this.userName,"Administrador de Proyectos").then(s=>{s.data.isValid?_.Get("Id",s.data.personId).then(t=>{this.idSubsidiary=t.data.data[0].subsidiaryId,this.idprojectManager=t.data.data[0].id,this.hasPM=!0}):this.hasPM=!1})}},handleSearch:async function(a){console.log("buscar",a),this.loadDataSource(22)},right:(a,e)=>a.substr(a.length-e,a.length),loadPeriods:async function(){const a=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];let e=new Date;for(let o=0;o<12;o++)this.months=[...this.months,{value:o+1,text:a[o]}];for(let o=e.getFullYear()-4;o<=e.getFullYear();o++)this.years=[...this.years,{value:o,text:`${o}`}]},loadDataSource:async function(a){console.log("carga data",this.year,this.month,this.idprojectManager),this.year!=0&&this.month!=0&&this.idprojectManager!=0&&(this.dataSource=new g({key:"id",load:e=>{console.log(e,e.filter,e.length);let o={};return["skip","take","requireTotalCount","requireGroupCount","sort","filter","totalSummary","group","groupSummary"].forEach(s=>{s in e&&pe(e[s])&&(o[s]=JSON.stringify(e[s]))}),console.log(o,`${x}/byprojectmanager/${this.idprojectManager}/${this.year}/${this.month}`),this.sendRequest(`${x}/byprojectmanager/${this.idprojectManager}/${this.year}/${this.month}`,"GET",o).then(s=>(console.log("datos,",s),s.map(t=>t.status=ue.GetStatus(t.state).value),{data:s,totalCount:s.length}))},byKey:e=>this.sendRequest(`${x}`,"GET",{Field:"ID",Value:e}).then(o=>o),update:(e,o)=>{const s=new Date;return o.ProjectId=e,o.ProjectReportDate=s,o.Period=this.periodo,console.log(e,o),this.sendRequest(`${x}`,"POST",{values:JSON.stringify(o)})}}))},addMonth:(a,e)=>new Date(a.setMonth(a.getMonth()+e)),sendRequest(a,e="GET",o={}){const s=Object.keys(o).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(o[t])}`).join("&");return e==="GET"?fetch(`${a}?${s}`,{method:e}).then(t=>t.json().then(c=>{if(t.ok)return c.data;throw c.Message})):fetch(a,{method:e,body:o.values,headers:{"Content-Type":"application/json;charset=UTF-8"}}).then(t=>t.ok?t.text().then(c=>c&&JSON.parse(c)):t.json().then(c=>{throw c.Message}))}},async mounted(){await this.getSubsidiaries(),await this.loadPeriods(),await this.validateUser();let a=new Date;this.year=a.getFullYear(),this.month=a.getMonth()+1}},xe={id:"main-content"},ge={class:"container-fluid"},_e={class:"block-header"},fe={class:"row clearfix"},De={class:"col-md-12 cont"},ye={class:"dx-field"},be=i("div",{class:"dx-field-label"},"Subsidiaria",-1),ve={class:"dx-field-value"},we={class:"dx-field"},Se=i("div",{class:"dx-field-label"},"Administrador de Proyecto",-1),je={class:"dx-field-value"},Pe={class:"dx-field"},Me=i("div",{class:"dx-field-label"},"A\xF1o",-1),Re={class:"dx-field-value"},Ge={class:"dx-field"},ke=i("div",{class:"dx-field-label"},"Mes",-1),Ce={class:"dx-field-value"},Oe={class:"row clearfix"},Fe={class:"col-md-12 cont"};function Ee(a,e,o,s,t,c){const v=n("bread-crumb"),u=n("DxSelectBox"),D=n("DxGroupItem"),w=n("DxForm"),S=n("DxHeaderFilter"),j=n("DxGroupPanel"),P=n("DxGrouping"),M=n("DxExport"),R=n("DxSearchPanel"),G=n("DxFilterRow"),k=n("DxScrolling"),C=n("DxPaging"),O=n("DxPager"),p=n("DxRequiredRule"),m=n("DxColumn"),F=n("cellLink"),E=n("DxDataGrid");return ne(),ce("div",xe,[i("div",ge,[i("div",_e,[r(v)]),i("div",fe,[i("div",De,[r(w,{"form-data":t.project,"col-count":2},{default:d(()=>[r(D,{"col-count":2},{default:d(()=>[i("div",ye,[be,i("div",ve,[r(u,{items:t.subsidiary,onValueChanged:c.subsidiaryChange,"display-expr":"name",disabled:t.hasPM,value:t.idSubsidiary,"onUpdate:value":e[0]||(e[0]=l=>t.idSubsidiary=l),"search-enabled":!0,"search-mode":t.searchModeOption,"search-expr":t.searchExprOption,"search-timeout":t.searchTimeoutOption,"min-search-length":t.minSearchLengthOption,"show-data-before-search":t.showDataBeforeSearchOption,"value-expr":"id"},null,8,["items","onValueChanged","disabled","value","search-mode","search-expr","search-timeout","min-search-length","show-data-before-search"])])]),i("div",we,[Se,i("div",je,[r(u,{items:t.projectManager,onValueChanged:c.loadDataSource,"display-expr":"fullName",value:t.idprojectManager,"onUpdate:value":e[1]||(e[1]=l=>t.idprojectManager=l),"value-expr":"id","data-field":"Position",disabled:t.hasPM,"search-enable":"true",id:"idprojectManager","search-enabled":!0,"search-mode":t.searchModeOption,"search-expr":t.searchExprOption,"search-timeout":t.searchTimeoutOption,"min-search-length":t.minSearchLengthOption,"show-data-before-search":t.showDataBeforeSearchOption},null,8,["items","onValueChanged","value","disabled","search-mode","search-expr","search-timeout","min-search-length","show-data-before-search"])])])]),_:1}),r(D,{"col-count":2},{default:d(()=>[i("div",Pe,[Me,i("div",Re,[r(u,{items:t.years,onValueChanged:c.loadDataSource,"display-expr":"text",value:t.year,"onUpdate:value":e[2]||(e[2]=l=>t.year=l),"value-expr":"value","search-enable":"true","search-enabled":!0,"search-mode":t.searchModeOption,"search-expr":t.searchExprOption,"search-timeout":t.searchTimeoutOption,"min-search-length":t.minSearchLengthOption,"show-data-before-search":t.showDataBeforeSearchOption},null,8,["items","onValueChanged","value","search-mode","search-expr","search-timeout","min-search-length","show-data-before-search"])])]),i("div",Ge,[ke,i("div",Ce,[r(u,{items:t.months,onValueChanged:c.loadDataSource,"display-expr":"text",value:t.month,"onUpdate:value":e[3]||(e[3]=l=>t.month=l),"value-expr":"value","search-enable":"true","search-enabled":!0,"search-mode":t.searchModeOption,"search-expr":t.searchExprOption,"search-timeout":t.searchTimeoutOption,"min-search-length":t.minSearchLengthOption,"show-data-before-search":t.showDataBeforeSearchOption},null,8,["items","onValueChanged","value","search-mode","search-expr","search-timeout","min-search-length","show-data-before-search"])])])]),_:1})]),_:1},8,["form-data"])]),i("div",Oe,[i("div",Fe,[r(E,{id:"dataGridActivities","show-borders":!0,"data-source":t.dataSource,"column-auto-width":!0,"repaint-changes-only":!0,"remote-operations":!0},{"cell-link-template":d(({data:l})=>[r(F,{"cell-data":l,routePath:{name:"ProjectReportViewDetails",params:{id:l.data.id}}},null,8,["cell-data","routePath"])]),default:d(()=>[r(S,{visible:!0}),r(j,{visible:!0}),r(P,{"auto-expand-all":!0}),r(M,{enabled:!0,"allow-export-selected-data":!0}),r(R,{visible:!0,width:240,placeholder:"Buscar..."}),r(G,{visible:!0}),r(k,{"row-rendering-mode":"virtual"}),r(C,{"page-size":10}),r(O,{visible:!0,"allowed-page-sizes":[10,20,50],"display-mode":a.displayMode,"show-page-size-selector":!0,"show-info":!1,"show-navigation-buttons":!0},null,8,["display-mode"]),r(m,{"allow-editing":!1,"data-field":"project.name",caption:"Nombre","cell-template":"cell-link-template"},{default:d(()=>[r(p)]),_:1}),r(m,{"allow-editing":!1,width:150,"data-field":"project.startDate","data-type":"date",format:"yyyy-MM-dd",caption:"Fecha Inicio"},{default:d(()=>[r(p)]),_:1}),r(m,{"allow-editing":!1,width:150,"data-field":"project.endDate","data-type":"date",format:"yyyy-MM-dd",caption:"Fecha Fin"},{default:d(()=>[r(p)]),_:1}),r(m,{"allow-editing":!1,width:300,"data-field":"status",caption:"Estado"},{default:d(()=>[r(p)]),_:1})]),_:1},8,["data-source"])])])])])])}var Ke=se(me,[["render",Ee]]);export{Ke as default};
